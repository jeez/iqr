SET(CMAKE_INSTALL_PREFIX /opt/iqr)
SET(CMAKE_VERBOSE_MAKEFILE TRUE) 

ADD_DEFINITIONS(-DQT_THREAD_SUPPORT -D_REENTRANT -DQT_NO_DEBUG -DIQRMODULE -DUSE_USBVIDEO_AS_BASECLASS ) 

SET(QT_MT_REQUIRED TRUE)
FIND_PACKAGE(Qt3 REQUIRED)


EXEC_PROGRAM(uname
 ARGS "-r"
 OUTPUT_VARIABLE KVER
)

EXEC_PROGRAM(uname
 ARGS "-p"
 OUTPUT_VARIABLE KPROC
)


IF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")
SET (libSrc 
  moduleUSBVideoPT.cpp
  ../USBVideo/moduleUSBVideo.cpp
  ../Common/v4ldemos/v4l.c
  ${CMAKE_CURRENT_SOURCE_DIR}/../Common/ccvt-0.3/ccvt_misc.c
)
ELSE(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")

SET (libSrc 
  moduleUSBVideoPT.cpp
  ../USBVideo/moduleUSBVideo.cpp
  ../Common/v4ldemos/v4l.c
  ${CMAKE_CURRENT_SOURCE_DIR}/../Common/ccvt-0.3/ccvt_c2.c
)
ENDIF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")



IF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")
#this hack is needed because cmake currently does not support assembler files...
ADD_CUSTOM_COMMAND(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/ccvt_mmx.o
 COMMAND gcc -c -I. -I/lib/modules/`uname -r`/source/include ${CMAKE_CURRENT_SOURCE_DIR}/../Common/ccvt-0.3/ccvt_mmx.S
 DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/../Common/ccvt-0.3/ccvt_mmx.S )
ENDIF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")

INCLUDE_directories(
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_SOURCE_DIR}/../USBVideo/
  ${CMAKE_CURRENT_SOURCE_DIR}/../Common
  ${CMAKE_CURRENT_SOURCE_DIR}/../Common/v4ldemos
  ${CMAKE_CURRENT_SOURCE_DIR}/../../Common/
  ${CMAKE_CURRENT_SOURCE_DIR}/../../../../
  ${CMAKE_CURRENT_SOURCE_DIR}/../../../../FE/icons/ModuleIcons/
  ${QT_INCLUDE_DIR}
  /usr/src/linux-${CMAKE_SYSTEM_VERSION}/include/media
  /usr/src/linux/include/media
  /usr/src/linux/drivers/usb/media/pwc
  /usr/src/kernels/${CMAKE_SYSTEM_VERSION}/include/media
  /usr/src/kernels/${CMAKE_SYSTEM_VERSION}-${KPROC}/include/media
  /lib/modules/${KVER}/build/include/media
)


IF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")
ADD_LIBRARY(moduleUSBVideoPT SHARED ${libSrc} ccvt_mmx.o)
ELSE(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")
ADD_LIBRARY(moduleUSBVideoPT SHARED ${libSrc})
ENDIF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")


SET_TARGET_PROPERTIES(moduleUSBVideoPT PROPERTIES PREFIX "")

INSTALL(TARGETS 
  moduleUSBVideoPT
#  LIBRARY DESTINATION lib/Modules/ 
  LIBRARY DESTINATION lib/iqr/Modules/ 
)


#SuSE:
#/usr/src/linux-2.6.16.27-0.6/drivers/usb/media/pwc/pwc-ioctl.h	

#Fedora:
#/usr/src/kernels/2.6.19-1.2288_1.fc5.cubbi_suspend2-smp-i686/include/media/pwc-ioctl.h


