MESSAGE("CMAKE_SYSTEM_PROCESSOR is ${CMAKE_SYSTEM_PROCESSOR}")

SET(CMAKE_INSTALL_PREFIX /opt/iqr)
SET(CMAKE_VERBOSE_MAKEFILE TRUE) 

ADD_DEFINITIONS(-DQT_THREAD_SUPPORT -D_REENTRANT -DQT_NO_DEBUG -DIQRMODULE)

SET(QT_MT_REQUIRED TRUE)
FIND_PACKAGE(Qt3 REQUIRED)




IF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")

SET (libSrc 
  moduleUSBVideo.cpp
  ../Common/v4ldemos/v4l.c
  ${CMAKE_CURRENT_SOURCE_DIR}/../Common/ccvt-0.3/ccvt_misc.c
)
ELSE(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")

SET (libSrc 
  moduleUSBVideo.cpp
  ../Common/v4ldemos/v4l.c
  ${CMAKE_CURRENT_SOURCE_DIR}/../Common/ccvt-0.3/ccvt_c2.c
)
ENDIF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")

    

IF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")
#this hack is needed because cmake currently does not support assembler files...
ADD_CUSTOM_COMMAND(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/ccvt_mmx.o
 COMMAND gcc -c -I. -I/lib/modules/`uname -r`/source/include ${CMAKE_CURRENT_SOURCE_DIR}/../Common/ccvt-0.3/ccvt_mmx.S
 DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/../Common/ccvt-0.3/ccvt_mmx.S )
ENDIF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")


INCLUDE_directories(
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_SOURCE_DIR}/../Common
  ${CMAKE_CURRENT_SOURCE_DIR}/../Common/v4ldemos
  ${CMAKE_CURRENT_SOURCE_DIR}/../../../../
  ${CMAKE_CURRENT_SOURCE_DIR}/../../../../FE/icons/ModuleIcons/
  ${QT_INCLUDE_DIR}
)


IF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")
ADD_LIBRARY(moduleUSBVideo SHARED ${libSrc} ccvt_mmx.o)
ELSE(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")
ADD_LIBRARY(moduleUSBVideo SHARED ${libSrc})
ENDIF(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i486" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i586" OR 
    ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i686")



SET_TARGET_PROPERTIES(moduleUSBVideo PROPERTIES PREFIX "")

INSTALL(TARGETS 
  moduleUSBVideo
#  LIBRARY DESTINATION ${CMAKE_CURRENT_SOURCE_DIR}/../../../../../lib/Modules/ 
#  LIBRARY DESTINATION lib/Modules/ 
  LIBRARY DESTINATION lib/iqr/Modules/ 
)



